{{define "partials/violation_card"}}
<div class="violation-card bg-white shadow sm:rounded-lg overflow-hidden"
     x-data="{ editing: false, notesExpanded: false }">
    <div class="p-6">
        <div class="flex gap-4">
            <!-- Thumbnail (if image linked) -->
            {{if .ThumbnailURL}}
            <div class="flex-shrink-0">
                <img src="{{.ThumbnailURL}}"
                     alt="Violation image"
                     class="h-24 w-24 object-cover rounded-lg border-2 border-gray-200">
            </div>
            {{end}}

            <!-- Main Content -->
            <div class="flex-1 min-w-0">
                <!-- Header Row: Status and Badges -->
                <div class="flex items-start justify-between mb-3">
                    <div class="flex flex-wrap gap-2">
                        <!-- Status Badge -->
                        {{if eq .Violation.Status "pending"}}
                        <span class="inline-flex items-center rounded-md bg-yellow-50 px-2.5 py-0.5 text-xs font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">
                            Pending Review
                        </span>
                        {{else if eq .Violation.Status "confirmed"}}
                        <span class="inline-flex items-center rounded-md bg-green-50 px-2.5 py-0.5 text-xs font-medium text-green-800 ring-1 ring-inset ring-green-600/20">
                            Confirmed
                        </span>
                        {{else if eq .Violation.Status "rejected"}}
                        <span class="inline-flex items-center rounded-md bg-gray-50 px-2.5 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/20">
                            Rejected
                        </span>
                        {{end}}

                        <!-- Severity Badge -->
                        {{if eq .Violation.Severity "critical"}}
                        <span class="inline-flex items-center rounded-md bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800">
                            Critical
                        </span>
                        {{else if eq .Violation.Severity "serious"}}
                        <span class="inline-flex items-center rounded-md bg-orange-100 px-2.5 py-0.5 text-xs font-medium text-orange-800">
                            Serious
                        </span>
                        {{else if eq .Violation.Severity "other"}}
                        <span class="inline-flex items-center rounded-md bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800">
                            Other
                        </span>
                        {{else if eq .Violation.Severity "recommendation"}}
                        <span class="inline-flex items-center rounded-md bg-blue-100 px-2.5 py-0.5 text-xs font-medium text-blue-800">
                            Recommendation
                        </span>
                        {{end}}

                        <!-- Confidence Badge (AI-detected only) -->
                        {{if .Violation.AIDescription}}
                        {{if eq .Violation.Confidence "high"}}
                        <span class="inline-flex items-center rounded-md bg-green-50 px-2.5 py-0.5 text-xs font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                            High Confidence
                        </span>
                        {{else if eq .Violation.Confidence "medium"}}
                        <span class="inline-flex items-center rounded-md bg-yellow-50 px-2.5 py-0.5 text-xs font-medium text-yellow-700 ring-1 ring-inset ring-yellow-600/20">
                            Medium Confidence
                        </span>
                        {{else if eq .Violation.Confidence "low"}}
                        <span class="inline-flex items-center rounded-md bg-gray-50 px-2.5 py-0.5 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/20">
                            Low Confidence
                        </span>
                        {{end}}
                        {{end}}

                        <!-- Manual vs AI Badge -->
                        {{if .Violation.AIDescription}}
                        <span class="inline-flex items-center rounded-md bg-purple-50 px-2.5 py-0.5 text-xs font-medium text-purple-700 ring-1 ring-inset ring-purple-700/10">
                            AI-Detected
                        </span>
                        {{else}}
                        <span class="inline-flex items-center rounded-md bg-blue-50 px-2.5 py-0.5 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">
                            Manual
                        </span>
                        {{end}}
                    </div>

                    <!-- Delete Button -->
                    <button
                        type="button"
                        hx-delete="/violations/{{.Violation.ID}}"
                        hx-confirm="Are you sure you want to delete this violation?"
                        hx-target="closest .violation-card"
                        hx-swap="outerHTML swap:1s"
                        class="text-gray-400 hover:text-red-600">
                        <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Description -->
                <div class="mb-4">
                    <div x-show="!editing">
                        <p class="text-sm text-gray-900 font-medium mb-2">{{.Violation.Description}}</p>
                        {{if .Violation.AIDescription}}
                        <p class="text-xs text-gray-500 italic">AI: {{.Violation.AIDescription}}</p>
                        {{end}}
                    </div>

                    <!-- Edit Form -->
                    <div x-show="editing" x-cloak>
                        <form hx-put="/violations/{{.Violation.ID}}"
                              hx-target="closest .violation-card"
                              hx-swap="outerHTML"
                              @htmx:after-request="editing = false">
                            <div class="space-y-3">
                                <div>
                                    <label for="description-{{.Violation.ID}}" class="block text-sm font-medium text-gray-700">
                                        Description
                                    </label>
                                    <textarea
                                        id="description-{{.Violation.ID}}"
                                        name="description"
                                        rows="3"
                                        required
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-navy focus:ring-navy sm:text-sm">{{.Violation.Description}}</textarea>
                                </div>

                                <div>
                                    <label for="severity-{{.Violation.ID}}" class="block text-sm font-medium text-gray-700">
                                        Severity
                                    </label>
                                    <select
                                        id="severity-{{.Violation.ID}}"
                                        name="severity"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-navy focus:ring-navy sm:text-sm">
                                        <option value="critical" {{if eq .Violation.Severity "critical"}}selected{{end}}>Critical</option>
                                        <option value="serious" {{if eq .Violation.Severity "serious"}}selected{{end}}>Serious</option>
                                        <option value="other" {{if eq .Violation.Severity "other"}}selected{{end}}>Other</option>
                                        <option value="recommendation" {{if eq .Violation.Severity "recommendation"}}selected{{end}}>Recommendation</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="notes-{{.Violation.ID}}" class="block text-sm font-medium text-gray-700">
                                        Inspector Notes
                                    </label>
                                    <textarea
                                        id="notes-{{.Violation.ID}}"
                                        name="inspector_notes"
                                        rows="2"
                                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-navy focus:ring-navy sm:text-sm">{{.Violation.InspectorNotes}}</textarea>
                                </div>

                                <div class="flex gap-2">
                                    <button
                                        type="submit"
                                        class="inline-flex items-center rounded-md bg-navy px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-navy/90">
                                        Save Changes
                                    </button>
                                    <button
                                        type="button"
                                        @click="editing = false"
                                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Linked Regulations -->
                {{if .Regulations}}
                <div class="mb-4">
                    <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Applicable OSHA Regulations</h4>
                    <ul class="space-y-1">
                        {{range .Regulations}}
                        <li class="text-sm">
                            <span class="font-medium text-navy">{{.StandardNumber}}</span>
                            <span class="text-gray-700">- {{.Title}}</span>
                            {{if .IsPrimary}}
                            <span class="ml-1 inline-flex items-center rounded-md bg-navy/10 px-1.5 py-0.5 text-xs font-medium text-navy">
                                Primary
                            </span>
                            {{end}}
                        </li>
                        {{end}}
                    </ul>
                </div>
                {{end}}

                <!-- Inspector Notes (collapsible) -->
                {{if .Violation.InspectorNotes}}
                <div class="mb-4" x-show="!editing">
                    <button
                        @click="notesExpanded = !notesExpanded"
                        class="text-xs font-semibold text-gray-700 uppercase tracking-wider flex items-center gap-1">
                        Inspector Notes
                        <svg class="h-4 w-4 transform transition-transform"
                             :class="{ 'rotate-180': notesExpanded }"
                             viewBox="0 0 20 20"
                             fill="currentColor">
                            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div x-show="notesExpanded" x-collapse class="mt-2 text-sm text-gray-700 bg-gray-50 p-3 rounded-md">
                        {{.Violation.InspectorNotes}}
                    </div>
                </div>
                {{end}}

                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-2" x-show="!editing">
                    <!-- Accept/Reject Buttons (for pending violations) -->
                    {{if eq .Violation.Status "pending"}}
                    <button
                        type="button"
                        hx-put="/violations/{{.Violation.ID}}/status"
                        hx-vals='{"status":"confirmed"}'
                        hx-target="closest .violation-card"
                        hx-swap="outerHTML"
                        class="inline-flex items-center rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
                        </svg>
                        Accept
                    </button>
                    <button
                        type="button"
                        hx-put="/violations/{{.Violation.ID}}/status"
                        hx-vals='{"status":"rejected"}'
                        hx-target="closest .violation-card"
                        hx-swap="outerHTML"
                        class="inline-flex items-center rounded-md bg-gray-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                        </svg>
                        Reject
                    </button>
                    {{else if eq .Violation.Status "rejected"}}
                    <!-- Revert to Pending Button -->
                    <button
                        type="button"
                        hx-put="/violations/{{.Violation.ID}}/status"
                        hx-vals='{"status":"pending"}'
                        hx-target="closest .violation-card"
                        hx-swap="outerHTML"
                        class="inline-flex items-center rounded-md bg-yellow-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-yellow-500">
                        Revert to Pending
                    </button>
                    {{else if eq .Violation.Status "confirmed"}}
                    <!-- Revert to Pending Button -->
                    <button
                        type="button"
                        hx-put="/violations/{{.Violation.ID}}/status"
                        hx-vals='{"status":"pending"}'
                        hx-target="closest .violation-card"
                        hx-swap="outerHTML"
                        class="inline-flex items-center rounded-md bg-yellow-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-yellow-500">
                        Revert to Pending
                    </button>
                    {{end}}

                    <!-- Edit Button -->
                    <button
                        type="button"
                        @click="editing = true"
                        class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        <svg class="-ml-0.5 mr-1.5 h-4 w-4 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                        </svg>
                        Edit
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{{end}}
