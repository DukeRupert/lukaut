{{define "title"}}{{.Inspection.Title}}{{end}}

{{define "breadcrumb"}}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-4">
        <li>
            <div>
                <a href="/inspections" class="text-gray-400 hover:text-gray-500">
                    Inspections
                </a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                </svg>
                <span class="ml-4 text-sm font-medium text-gray-500">{{.Inspection.Title}}</span>
            </div>
        </li>
    </ol>
</nav>
{{end}}

{{define "content"}}
<div x-data
     @keydown.v.window="if (!['INPUT','TEXTAREA','SELECT'].includes($event.target.tagName) && !$event.metaKey && !$event.ctrlKey && !$event.altKey && {{gt .ViolationCounts.Total 0}}) { window.location.href = '/inspections/{{.InspectionID}}/review'; $event.preventDefault(); }">

<!-- Header with actions -->
<div class="md:flex md:items-center md:justify-between mb-6">
    <div class="min-w-0 flex-1">
        <h2 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
            {{.Inspection.Title}}
        </h2>
        <div class="mt-1 flex flex-col sm:mt-0 sm:flex-row sm:flex-wrap sm:space-x-6">
            <div class="mt-2 flex items-center text-sm text-gray-500">
                <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M5.75 2a.75.75 0 01.75.75V4h7V2.75a.75.75 0 011.5 0V4h.25A2.75 2.75 0 0118 6.75v8.5A2.75 2.75 0 0115.25 18H4.75A2.75 2.75 0 012 15.25v-8.5A2.75 2.75 0 014.75 4H5V2.75A.75.75 0 015.75 2zm-1 5.5c-.69 0-1.25.56-1.25 1.25v6.5c0 .69.56 1.25 1.25 1.25h10.5c.69 0 1.25-.56 1.25-1.25v-6.5c0-.69-.56-1.25-1.25-1.25H4.75z" clip-rule="evenodd" />
                </svg>
                {{formatDate .Inspection.InspectionDate}}
            </div>
            {{if .Inspection.SiteName}}
            <div class="mt-2 flex items-center text-sm text-gray-500">
                <svg class="mr-1.5 h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.096.446-.24.757-.433.62-.384 1.445-.966 2.274-1.765C15.302 14.988 17 12.493 17 9A7 7 0 103 9c0 3.492 1.698 5.988 3.355 7.584a13.731 13.731 0 002.273 1.765 11.842 11.842 0 00.976.544l.062.029.018.008.006.003zM10 11.25a2.25 2.25 0 100-4.5 2.25 2.25 0 000 4.5z" clip-rule="evenodd" />
                </svg>
                {{.Inspection.SiteName}}
            </div>
            {{end}}
            <div class="mt-2 flex items-center text-sm">
                <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium {{statusColor .Inspection.Status}}">
                    {{title .Inspection.Status}}
                </span>
            </div>
        </div>
    </div>
    <div class="mt-4 flex md:ml-4 md:mt-0 gap-x-3">
        <a href="/inspections/{{.Inspection.ID}}/edit"
           class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
            <svg class="-ml-0.5 mr-1.5 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
            </svg>
            Edit
        </a>
        <a href="/inspections"
           class="inline-flex items-center rounded-md bg-navy px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-navy/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-navy">
            Back to List
        </a>
    </div>
</div>

<!-- Details Card -->
<div class="bg-white shadow sm:rounded-lg mb-6">
    <div class="px-4 py-5 sm:p-6">
        <h3 class="text-base font-semibold leading-6 text-gray-900 mb-4">Inspection Details</h3>
        <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            {{if .Inspection.SiteName}}
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Site</dt>
                <dd class="mt-1 text-sm text-gray-900">{{.Inspection.SiteName}}</dd>
                {{if .Inspection.SiteAddress}}
                <dd class="mt-1 text-sm text-gray-500">
                    {{.Inspection.SiteAddress}}<br>
                    {{.Inspection.SiteCity}}, {{.Inspection.SiteState}}
                </dd>
                {{end}}
            </div>
            {{end}}

            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Inspection Date</dt>
                <dd class="mt-1 text-sm text-gray-900">{{formatDate .Inspection.InspectionDate}}</dd>
            </div>

            {{if .Inspection.WeatherConditions}}
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Weather Conditions</dt>
                <dd class="mt-1 text-sm text-gray-900">{{.Inspection.WeatherConditions}}</dd>
            </div>
            {{end}}

            {{if .Inspection.Temperature}}
            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Temperature</dt>
                <dd class="mt-1 text-sm text-gray-900">{{.Inspection.Temperature}}</dd>
            </div>
            {{end}}

            {{if .Inspection.InspectorNotes}}
            <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Inspector Notes</dt>
                <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap">{{.Inspection.InspectorNotes}}</dd>
            </div>
            {{end}}

            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Created</dt>
                <dd class="mt-1 text-sm text-gray-900">{{formatDate .Inspection.CreatedAt}}</dd>
            </div>

            <div class="sm:col-span-1">
                <dt class="text-sm font-medium text-gray-500">Last Updated</dt>
                <dd class="mt-1 text-sm text-gray-900">{{formatDate .Inspection.UpdatedAt}}</dd>
            </div>
        </dl>
    </div>
</div>

<!-- Unified Photos Section -->
<div class="bg-white shadow sm:rounded-lg mb-6"
     x-data="{
         isDragging: false,
         isUploading: false,
         progress: 0,
         handleFiles(files) {
             if (!files || files.length === 0) return;
             this.uploadFiles(files);
         },
         uploadFiles(files) {
             this.isUploading = true;
             this.progress = 0;

             const formData = new FormData();
             for (let i = 0; i < files.length; i++) {
                 formData.append('images', files[i]);
             }

             const xhr = new XMLHttpRequest();

             xhr.upload.addEventListener('progress', (e) => {
                 if (e.lengthComputable) {
                     this.progress = Math.round((e.loaded / e.total) * 100);
                 }
             });

             xhr.addEventListener('load', () => {
                 this.isUploading = false;
                 this.progress = 0;
                 if (xhr.status === 200) {
                     // Replace gallery with response
                     const gallery = document.getElementById('image-gallery');
                     if (gallery) {
                         gallery.outerHTML = xhr.responseText;
                     }
                 } else {
                     alert('Upload failed. Please try again.');
                 }
             });

             xhr.addEventListener('error', () => {
                 this.isUploading = false;
                 this.progress = 0;
                 alert('Upload failed. Please check your connection and try again.');
             });

             xhr.open('POST', '/inspections/{{.InspectionID}}/images');
             xhr.send(formData);
         }
     }"
     @keydown.u.window="if (!['INPUT','TEXTAREA','SELECT'].includes($event.target.tagName) && !$event.metaKey && !$event.ctrlKey && !$event.altKey) { $refs.fileInput.click(); $event.preventDefault(); }">

    <div class="px-4 py-5 sm:p-6">
        <!-- Header with upload button -->
        <div class="flex items-center justify-between mb-4">
            <div>
                <h3 class="text-base font-semibold leading-6 text-gray-900">Site Photos</h3>
                <p class="mt-1 text-sm text-gray-500">
                    {{if .CanUpload}}Press <kbd class="px-1.5 py-0.5 text-xs font-semibold bg-gray-100 border border-gray-200 rounded">U</kbd> to upload{{end}}
                </p>
            </div>
            {{if .CanUpload}}
            <label class="cursor-pointer inline-flex items-center rounded-md bg-navy px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-navy/90 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-navy">
                <svg class="-ml-0.5 mr-1.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M9.25 13.25a.75.75 0 001.5 0V4.636l2.955 3.129a.75.75 0 001.09-1.03l-4.25-4.5a.75.75 0 00-1.09 0l-4.25 4.5a.75.75 0 101.09 1.03L9.25 4.636v8.614z" />
                    <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5z" />
                </svg>
                Upload Photos
                <input type="file"
                       x-ref="fileInput"
                       class="sr-only"
                       multiple
                       accept="image/jpeg,image/png"
                       @change="handleFiles($event.target.files)">
            </label>
            {{end}}
        </div>

        <!-- Drag and drop zone (shown when dragging or when no images) -->
        {{if .CanUpload}}
        <div x-show="isDragging"
             x-transition
             class="mb-4 flex justify-center rounded-lg border-2 border-dashed border-blue-400 bg-blue-50 px-6 py-10"
             @dragover.prevent="isDragging = true"
             @dragleave.prevent="isDragging = false"
             @drop.prevent="isDragging = false; handleFiles($event.dataTransfer.files)">
            <div class="text-center">
                <svg class="mx-auto h-12 w-12 text-blue-400" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                </svg>
                <p class="mt-2 text-sm font-medium text-blue-600">Drop files to upload</p>
            </div>
        </div>
        {{end}}

        <!-- Invisible drag detection overlay -->
        {{if .CanUpload}}
        <div class="fixed inset-0 z-50 pointer-events-none"
             :class="{ 'pointer-events-auto': !isDragging }"
             @dragover.prevent="isDragging = true"
             x-show="false"></div>
        {{end}}

        <!-- Progress bar -->
        <div x-show="isUploading" x-transition class="mb-4">
            <div class="flex items-center justify-between mb-1">
                <span class="text-sm font-medium text-gray-700">Uploading...</span>
                <span class="text-sm font-medium text-gray-700" x-text="progress + '%'"></span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-navy h-2.5 rounded-full transition-all duration-300"
                     :style="'width: ' + progress + '%'"></div>
            </div>
        </div>

        <!-- Image Gallery -->
        {{template "image_gallery" .GalleryData}}

        <!-- Analyzing indicator -->
        {{if .IsAnalyzing}}
        <div class="mt-4 flex items-center justify-center py-3 px-4 bg-blue-50 rounded-lg">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm font-medium text-blue-700">Analyzing images...</span>
        </div>
        {{end}}
    </div>
</div>

<!-- Violations Section (Summary Only) -->
{{template "partials/violations_summary" .}}

</div><!-- end keyboard shortcuts wrapper -->
{{end}}
