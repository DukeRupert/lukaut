{{define "title"}}Review Violations - {{.Inspection.Title}}{{end}}

{{define "breadcrumb"}}
<nav class="flex" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-4">
        <li>
            <div>
                <a href="/inspections" class="text-gray-400 hover:text-gray-500">
                    Inspections
                </a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                </svg>
                <a href="/inspections/{{.Inspection.ID}}" class="ml-4 text-sm font-medium text-gray-400 hover:text-gray-500">
                    {{.Inspection.Title}}
                </a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <svg class="h-5 w-5 flex-shrink-0 text-gray-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                </svg>
                <span class="ml-4 text-sm font-medium text-gray-500">Review</span>
            </div>
        </li>
    </ol>
</nav>
{{end}}

{{define "content"}}
<div x-data="violationReview()" x-init="init()">
    <!-- Header Bar -->
    <div class="flex items-center justify-between mb-6">
        <a href="/inspections/{{.Inspection.ID}}"
           class="inline-flex items-center text-sm text-gray-500 hover:text-gray-700">
            <svg class="mr-1 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" />
            </svg>
            Back to Inspection
        </a>

        <div class="flex items-center gap-4">
            <!-- Progress -->
            <span class="text-sm text-gray-600" x-show="!isComplete">
                Reviewing <span class="font-semibold" x-text="currentIndex + 1"></span> of <span class="font-semibold" x-text="violations.length"></span>
            </span>

            <!-- Progress Bar -->
            <div class="w-32 bg-gray-200 rounded-full h-2" x-show="!isComplete">
                <div class="bg-navy h-2 rounded-full transition-all duration-300"
                     :style="'width: ' + ((currentIndex + 1) / violations.length * 100) + '%'"></div>
            </div>

            <!-- List View Link -->
            <a href="/inspections/{{.Inspection.ID}}/review"
               class="text-sm text-gray-500 hover:text-gray-700">
                Switch to list view
            </a>

            <!-- Keyboard hint -->
            <span class="text-xs text-gray-400">
                Press <kbd class="px-1.5 py-0.5 bg-gray-100 border border-gray-200 rounded font-semibold">Esc</kbd> to exit
            </span>
        </div>
    </div>

    <!-- Completion Screen -->
    <div x-show="isComplete" x-cloak class="bg-white shadow sm:rounded-lg">
        <div class="px-4 py-12 sm:p-12 text-center">
            <div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100 mb-4">
                <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Review Complete!</h3>
            <p class="text-sm text-gray-500 mb-6">You've reviewed all violations for this inspection.</p>

            <div class="flex justify-center gap-8 mb-8">
                <div class="text-center">
                    <div class="text-3xl font-bold text-green-600" x-text="confirmedCount"></div>
                    <div class="text-sm text-gray-500">Confirmed</div>
                </div>
                <div class="text-center">
                    <div class="text-3xl font-bold text-gray-600" x-text="rejectedCount"></div>
                    <div class="text-sm text-gray-500">Rejected</div>
                </div>
            </div>

            <div class="flex justify-center gap-3">
                <a href="/inspections/{{.Inspection.ID}}"
                   class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                    Return to Inspection
                </a>
                <a href="/inspections/{{.Inspection.ID}}/report"
                   class="inline-flex items-center rounded-md bg-navy px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-navy/90">
                    Generate Report
                </a>
            </div>
        </div>
    </div>

    <!-- Single Violation View -->
    <div x-show="!isComplete && violations.length > 0" x-cloak>
        <div class="bg-white shadow sm:rounded-lg overflow-hidden">
            <div class="p-6">
                <!-- Two Column Layout: Image + Details -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Left: Image -->
                    <div>
                        <template x-if="current && current.thumbnailURL">
                            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden">
                                <img :src="current.originalURL || current.thumbnailURL"
                                     :alt="current.description"
                                     class="w-full h-full object-contain"
                                     @click="window.open(current.originalURL, '_blank')">
                            </div>
                        </template>
                        <template x-if="current && !current.thumbnailURL">
                            <div class="aspect-square bg-gray-100 rounded-lg flex items-center justify-center">
                                <div class="text-center text-gray-400">
                                    <svg class="mx-auto h-16 w-16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                    </svg>
                                    <p class="mt-2 text-sm">No image linked</p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Right: Details -->
                    <div class="flex flex-col">
                        <!-- Status Badges -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <!-- Status -->
                            <span x-show="current && current.status === 'pending'"
                                  class="inline-flex items-center rounded-md bg-yellow-50 px-2.5 py-1 text-sm font-medium text-yellow-800 ring-1 ring-inset ring-yellow-600/20">
                                Pending Review
                            </span>
                            <span x-show="current && current.status === 'confirmed'"
                                  class="inline-flex items-center rounded-md bg-green-50 px-2.5 py-1 text-sm font-medium text-green-800 ring-1 ring-inset ring-green-600/20">
                                Confirmed
                            </span>
                            <span x-show="current && current.status === 'rejected'"
                                  class="inline-flex items-center rounded-md bg-gray-50 px-2.5 py-1 text-sm font-medium text-gray-600 ring-1 ring-inset ring-gray-500/20">
                                Rejected
                            </span>

                            <!-- Severity -->
                            <span x-show="current && current.severity === 'critical'"
                                  class="inline-flex items-center rounded-md bg-red-100 px-2.5 py-1 text-sm font-medium text-red-800">
                                Critical
                            </span>
                            <span x-show="current && current.severity === 'serious'"
                                  class="inline-flex items-center rounded-md bg-orange-100 px-2.5 py-1 text-sm font-medium text-orange-800">
                                Serious
                            </span>
                            <span x-show="current && current.severity === 'other'"
                                  class="inline-flex items-center rounded-md bg-yellow-100 px-2.5 py-1 text-sm font-medium text-yellow-800">
                                Other
                            </span>
                            <span x-show="current && current.severity === 'recommendation'"
                                  class="inline-flex items-center rounded-md bg-blue-100 px-2.5 py-1 text-sm font-medium text-blue-800">
                                Recommendation
                            </span>

                            <!-- Confidence -->
                            <span x-show="current && current.confidence === 'high'"
                                  class="inline-flex items-center rounded-md bg-green-50 px-2.5 py-1 text-sm font-medium text-green-700 ring-1 ring-inset ring-green-600/20">
                                High Confidence
                            </span>
                            <span x-show="current && current.confidence === 'medium'"
                                  class="inline-flex items-center rounded-md bg-yellow-50 px-2.5 py-1 text-sm font-medium text-yellow-700 ring-1 ring-inset ring-yellow-600/20">
                                Medium Confidence
                            </span>
                            <span x-show="current && current.confidence === 'low'"
                                  class="inline-flex items-center rounded-md bg-gray-50 px-2.5 py-1 text-sm font-medium text-gray-600 ring-1 ring-inset ring-gray-500/20">
                                Low Confidence
                            </span>

                            <!-- AI Badge -->
                            <span x-show="current && current.aiDescription"
                                  class="inline-flex items-center rounded-md bg-purple-50 px-2.5 py-1 text-sm font-medium text-purple-700 ring-1 ring-inset ring-purple-700/10">
                                AI-Detected
                            </span>
                            <span x-show="current && !current.aiDescription"
                                  class="inline-flex items-center rounded-md bg-blue-50 px-2.5 py-1 text-sm font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">
                                Manual
                            </span>
                        </div>

                        <!-- Description -->
                        <div class="mb-4" x-show="!editing">
                            <h3 class="text-lg font-semibold text-gray-900 mb-2" x-text="current ? current.description : ''"></h3>
                            <p x-show="current && current.aiDescription"
                               class="text-sm text-gray-500 italic"
                               x-text="current ? 'AI: ' + current.aiDescription : ''"></p>
                        </div>

                        <!-- Edit Form -->
                        <div x-show="editing" x-cloak class="mb-4">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <textarea x-model="editForm.description"
                                              rows="3"
                                              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-navy focus:ring-navy sm:text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Severity</label>
                                    <select x-model="editForm.severity"
                                            class="block w-full rounded-md border-gray-300 shadow-sm focus:border-navy focus:ring-navy sm:text-sm">
                                        <option value="critical">Critical</option>
                                        <option value="serious">Serious</option>
                                        <option value="other">Other</option>
                                        <option value="recommendation">Recommendation</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Inspector Notes</label>
                                    <textarea x-model="editForm.inspectorNotes"
                                              rows="2"
                                              class="block w-full rounded-md border-gray-300 shadow-sm focus:border-navy focus:ring-navy sm:text-sm"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Regulations -->
                        <div x-show="current && current.regulations && current.regulations.length > 0 && !editing" class="mb-4">
                            <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Applicable OSHA Regulations</h4>
                            <ul class="space-y-1">
                                <template x-for="reg in (current ? current.regulations : [])" :key="reg.id">
                                    <li class="text-sm">
                                        <span class="font-medium text-navy" x-text="reg.standardNumber"></span>
                                        <span class="text-gray-700" x-text="' - ' + reg.title"></span>
                                        <span x-show="reg.isPrimary"
                                              class="ml-1 inline-flex items-center rounded-md bg-navy/10 px-1.5 py-0.5 text-xs font-medium text-navy">
                                            Primary
                                        </span>
                                    </li>
                                </template>
                            </ul>
                        </div>

                        <!-- Inspector Notes Display -->
                        <div x-show="current && current.inspectorNotes && !editing" class="mb-4">
                            <h4 class="text-xs font-semibold text-gray-700 uppercase tracking-wider mb-2">Inspector Notes</h4>
                            <p class="text-sm text-gray-700 bg-gray-50 p-3 rounded-md" x-text="current ? current.inspectorNotes : ''"></p>
                        </div>

                        <!-- Spacer -->
                        <div class="flex-1"></div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                <div class="flex items-center justify-between">
                    <!-- Navigation -->
                    <div class="flex items-center gap-2">
                        <button @click="prev()"
                                :disabled="currentIndex === 0"
                                :class="currentIndex === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300">
                            <svg class="mr-1 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" />
                            </svg>
                            <kbd class="hidden sm:inline px-1 py-0.5 text-xs bg-gray-100 rounded">K</kbd>
                        </button>
                        <button @click="next()"
                                :disabled="currentIndex === violations.length - 1"
                                :class="currentIndex === violations.length - 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-200'"
                                class="inline-flex items-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300">
                            <kbd class="hidden sm:inline px-1 py-0.5 text-xs bg-gray-100 rounded">J</kbd>
                            <svg class="ml-1 h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center gap-3">
                        <!-- Edit Mode Buttons -->
                        <template x-if="editing">
                            <div class="flex items-center gap-2">
                                <button @click="saveEdit()"
                                        class="inline-flex items-center rounded-md bg-navy px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-navy/90">
                                    Save Changes
                                </button>
                                <button @click="cancelEdit()"
                                        class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                    Cancel
                                </button>
                            </div>
                        </template>

                        <!-- Review Mode Buttons -->
                        <template x-if="!editing">
                            <div class="flex items-center gap-2">
                                <button @click="accept()"
                                        class="inline-flex items-center rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">
                                    <kbd class="mr-2 px-1.5 py-0.5 text-xs bg-green-700 rounded">A</kbd>
                                    Accept
                                </button>
                                <button @click="reject()"
                                        class="inline-flex items-center rounded-md bg-gray-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500">
                                    <kbd class="mr-2 px-1.5 py-0.5 text-xs bg-gray-700 rounded">R</kbd>
                                    Reject
                                </button>
                                <button @click="startEdit()"
                                        class="inline-flex items-center rounded-md bg-white px-4 py-2 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                                    <kbd class="mr-2 px-1.5 py-0.5 text-xs bg-gray-100 rounded">E</kbd>
                                    Edit
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Empty State -->
    <div x-show="violations.length === 0" class="bg-white shadow sm:rounded-lg">
        <div class="px-4 py-12 sm:p-12 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900">No violations to review</h3>
            <p class="mt-1 text-sm text-gray-500">Upload photos and run AI analysis to detect violations.</p>
            <div class="mt-6">
                <a href="/inspections/{{.Inspection.ID}}"
                   class="inline-flex items-center rounded-md bg-navy px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-navy/90">
                    Return to Inspection
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Violations Data -->
<script>
    const violationsData = [
        {{range $i, $v := .Violations}}
        {{if $i}},{{end}}
        {
            id: "{{$v.Violation.ID}}",
            description: {{$v.Violation.Description | json}},
            aiDescription: {{if $v.Violation.AIDescription}}{{$v.Violation.AIDescription | json}}{{else}}""{{end}},
            status: "{{$v.Violation.Status}}",
            severity: "{{$v.Violation.Severity}}",
            confidence: "{{$v.Violation.Confidence}}",
            inspectorNotes: {{if $v.Violation.InspectorNotes}}{{$v.Violation.InspectorNotes | json}}{{else}}""{{end}},
            thumbnailURL: "{{$v.ThumbnailURL}}",
            originalURL: "{{if $v.Violation.ImageID}}/images/{{$v.Violation.ImageID}}/original{{end}}",
            regulations: [
                {{range $j, $reg := $v.Regulations}}
                {{if $j}},{{end}}
                {
                    id: "{{$reg.RegulationID}}",
                    standardNumber: "{{$reg.StandardNumber}}",
                    title: {{$reg.Title | json}},
                    isPrimary: {{$reg.IsPrimary}}
                }
                {{end}}
            ]
        }
        {{end}}
    ];

    const inspectionID = "{{.Inspection.ID}}";

    function violationReview() {
        return {
            violations: [],
            currentIndex: 0,
            editing: false,
            editForm: {
                description: '',
                severity: '',
                inspectorNotes: ''
            },

            init() {
                this.violations = violationsData;

                // Find first pending violation
                const firstPending = this.violations.findIndex(v => v.status === 'pending');
                if (firstPending >= 0) {
                    this.currentIndex = firstPending;
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeydown(e));
            },

            get current() {
                return this.violations[this.currentIndex] || null;
            },

            get isComplete() {
                return this.violations.length > 0 && this.violations.every(v => v.status !== 'pending');
            },

            get confirmedCount() {
                return this.violations.filter(v => v.status === 'confirmed').length;
            },

            get rejectedCount() {
                return this.violations.filter(v => v.status === 'rejected').length;
            },

            handleKeydown(e) {
                // Don't handle if in input field
                if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
                    // Allow Escape to cancel edit
                    if (e.key === 'Escape' && this.editing) {
                        this.cancelEdit();
                        e.preventDefault();
                    }
                    return;
                }

                // Don't handle with modifier keys (except for arrows)
                if (e.metaKey || e.ctrlKey || e.altKey) return;

                switch (e.key.toLowerCase()) {
                    case 'a':
                        if (!this.editing && !this.isComplete) {
                            this.accept();
                            e.preventDefault();
                        }
                        break;
                    case 'r':
                        if (!this.editing && !this.isComplete) {
                            this.reject();
                            e.preventDefault();
                        }
                        break;
                    case 'e':
                        if (!this.editing && !this.isComplete) {
                            this.startEdit();
                            e.preventDefault();
                        }
                        break;
                    case 'j':
                    case 'arrowright':
                        if (!this.editing) {
                            this.next();
                            e.preventDefault();
                        }
                        break;
                    case 'k':
                    case 'arrowleft':
                        if (!this.editing) {
                            this.prev();
                            e.preventDefault();
                        }
                        break;
                    case 'escape':
                        if (this.editing) {
                            this.cancelEdit();
                        } else {
                            window.location.href = '/inspections/' + inspectionID;
                        }
                        e.preventDefault();
                        break;
                }
            },

            next() {
                if (this.currentIndex < this.violations.length - 1) {
                    this.currentIndex++;
                }
            },

            prev() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                }
            },

            async accept() {
                await this.updateStatus('confirmed');
                this.advanceToNext();
            },

            async reject() {
                await this.updateStatus('rejected');
                this.advanceToNext();
            },

            advanceToNext() {
                // Find next pending violation
                for (let i = this.currentIndex + 1; i < this.violations.length; i++) {
                    if (this.violations[i].status === 'pending') {
                        this.currentIndex = i;
                        return;
                    }
                }
                // If none found after, check before
                for (let i = 0; i < this.currentIndex; i++) {
                    if (this.violations[i].status === 'pending') {
                        this.currentIndex = i;
                        return;
                    }
                }
                // All reviewed - stay on current (isComplete will show completion screen)
            },

            async updateStatus(status) {
                const violation = this.current;
                if (!violation) return;

                try {
                    const response = await fetch(`/violations/${violation.id}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ status })
                    });

                    if (response.ok) {
                        // Update local state
                        this.violations[this.currentIndex].status = status;
                    } else {
                        console.error('Failed to update status');
                    }
                } catch (error) {
                    console.error('Error updating status:', error);
                }
            },

            startEdit() {
                if (!this.current) return;
                this.editForm = {
                    description: this.current.description,
                    severity: this.current.severity,
                    inspectorNotes: this.current.inspectorNotes || ''
                };
                this.editing = true;
            },

            cancelEdit() {
                this.editing = false;
            },

            async saveEdit() {
                const violation = this.current;
                if (!violation) return;

                try {
                    const response = await fetch(`/violations/${violation.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'Accept': 'application/json'
                        },
                        body: new URLSearchParams({
                            description: this.editForm.description,
                            severity: this.editForm.severity,
                            inspector_notes: this.editForm.inspectorNotes
                        })
                    });

                    if (response.ok) {
                        // Update local state
                        this.violations[this.currentIndex].description = this.editForm.description;
                        this.violations[this.currentIndex].severity = this.editForm.severity;
                        this.violations[this.currentIndex].inspectorNotes = this.editForm.inspectorNotes;
                        this.editing = false;
                    } else {
                        console.error('Failed to save edit');
                    }
                } catch (error) {
                    console.error('Error saving edit:', error);
                }
            }
        };
    }
</script>
{{end}}
