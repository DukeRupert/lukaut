// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: images.sql

package repository

import (
	"context"
	"database/sql"

	"github.com/google/uuid"
)

const countImagesByInspectionID = `-- name: CountImagesByInspectionID :one
SELECT COUNT(*) FROM images
WHERE inspection_id = $1
`

func (q *Queries) CountImagesByInspectionID(ctx context.Context, inspectionID uuid.UUID) (int64, error) {
	row := q.db.QueryRowContext(ctx, countImagesByInspectionID, inspectionID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const countPendingImagesByInspectionID = `-- name: CountPendingImagesByInspectionID :one
SELECT COUNT(*) FROM images
WHERE inspection_id = $1
AND (analysis_status IS NULL OR analysis_status = 'pending')
`

// Count images that haven't been analyzed yet
func (q *Queries) CountPendingImagesByInspectionID(ctx context.Context, inspectionID uuid.UUID) (int64, error) {
	row := q.db.QueryRowContext(ctx, countPendingImagesByInspectionID, inspectionID)
	var count int64
	err := row.Scan(&count)
	return count, err
}

const createImage = `-- name: CreateImage :one
INSERT INTO images (
    inspection_id,
    storage_key,
    thumbnail_key,
    original_filename,
    content_type,
    size_bytes,
    width,
    height,
    analysis_status
) VALUES (
    $1, $2, $3, $4, $5, $6, $7, $8, $9
)
RETURNING id, inspection_id, storage_key, thumbnail_key, original_filename, content_type, size_bytes, width, height, analysis_status, analysis_completed_at, created_at
`

type CreateImageParams struct {
	InspectionID     uuid.UUID      `json:"inspection_id"`
	StorageKey       string         `json:"storage_key"`
	ThumbnailKey     sql.NullString `json:"thumbnail_key"`
	OriginalFilename sql.NullString `json:"original_filename"`
	ContentType      string         `json:"content_type"`
	SizeBytes        int32          `json:"size_bytes"`
	Width            sql.NullInt32  `json:"width"`
	Height           sql.NullInt32  `json:"height"`
	AnalysisStatus   sql.NullString `json:"analysis_status"`
}

func (q *Queries) CreateImage(ctx context.Context, arg CreateImageParams) (Image, error) {
	row := q.db.QueryRowContext(ctx, createImage,
		arg.InspectionID,
		arg.StorageKey,
		arg.ThumbnailKey,
		arg.OriginalFilename,
		arg.ContentType,
		arg.SizeBytes,
		arg.Width,
		arg.Height,
		arg.AnalysisStatus,
	)
	var i Image
	err := row.Scan(
		&i.ID,
		&i.InspectionID,
		&i.StorageKey,
		&i.ThumbnailKey,
		&i.OriginalFilename,
		&i.ContentType,
		&i.SizeBytes,
		&i.Width,
		&i.Height,
		&i.AnalysisStatus,
		&i.AnalysisCompletedAt,
		&i.CreatedAt,
	)
	return i, err
}

const deleteImageByID = `-- name: DeleteImageByID :exec
DELETE FROM images
WHERE id = $1
`

func (q *Queries) DeleteImageByID(ctx context.Context, id uuid.UUID) error {
	_, err := q.db.ExecContext(ctx, deleteImageByID, id)
	return err
}

const getImageByID = `-- name: GetImageByID :one
SELECT id, inspection_id, storage_key, thumbnail_key, original_filename, content_type, size_bytes, width, height, analysis_status, analysis_completed_at, created_at FROM images
WHERE id = $1
`

func (q *Queries) GetImageByID(ctx context.Context, id uuid.UUID) (Image, error) {
	row := q.db.QueryRowContext(ctx, getImageByID, id)
	var i Image
	err := row.Scan(
		&i.ID,
		&i.InspectionID,
		&i.StorageKey,
		&i.ThumbnailKey,
		&i.OriginalFilename,
		&i.ContentType,
		&i.SizeBytes,
		&i.Width,
		&i.Height,
		&i.AnalysisStatus,
		&i.AnalysisCompletedAt,
		&i.CreatedAt,
	)
	return i, err
}

const getImageByIDAndInspectionID = `-- name: GetImageByIDAndInspectionID :one
SELECT id, inspection_id, storage_key, thumbnail_key, original_filename, content_type, size_bytes, width, height, analysis_status, analysis_completed_at, created_at FROM images
WHERE id = $1 AND inspection_id = $2
`

type GetImageByIDAndInspectionIDParams struct {
	ID           uuid.UUID `json:"id"`
	InspectionID uuid.UUID `json:"inspection_id"`
}

func (q *Queries) GetImageByIDAndInspectionID(ctx context.Context, arg GetImageByIDAndInspectionIDParams) (Image, error) {
	row := q.db.QueryRowContext(ctx, getImageByIDAndInspectionID, arg.ID, arg.InspectionID)
	var i Image
	err := row.Scan(
		&i.ID,
		&i.InspectionID,
		&i.StorageKey,
		&i.ThumbnailKey,
		&i.OriginalFilename,
		&i.ContentType,
		&i.SizeBytes,
		&i.Width,
		&i.Height,
		&i.AnalysisStatus,
		&i.AnalysisCompletedAt,
		&i.CreatedAt,
	)
	return i, err
}

const getImageByIDWithInspection = `-- name: GetImageByIDWithInspection :one
SELECT i.id, i.inspection_id, i.storage_key, i.thumbnail_key, i.original_filename, i.content_type, i.size_bytes, i.width, i.height, i.analysis_status, i.analysis_completed_at, i.created_at, ins.user_id
FROM images i
JOIN inspections ins ON ins.id = i.inspection_id
WHERE i.id = $1
`

type GetImageByIDWithInspectionRow struct {
	ID                  uuid.UUID      `json:"id"`
	InspectionID        uuid.UUID      `json:"inspection_id"`
	StorageKey          string         `json:"storage_key"`
	ThumbnailKey        sql.NullString `json:"thumbnail_key"`
	OriginalFilename    sql.NullString `json:"original_filename"`
	ContentType         string         `json:"content_type"`
	SizeBytes           int32          `json:"size_bytes"`
	Width               sql.NullInt32  `json:"width"`
	Height              sql.NullInt32  `json:"height"`
	AnalysisStatus      sql.NullString `json:"analysis_status"`
	AnalysisCompletedAt sql.NullTime   `json:"analysis_completed_at"`
	CreatedAt           sql.NullTime   `json:"created_at"`
	UserID              uuid.UUID      `json:"user_id"`
}

func (q *Queries) GetImageByIDWithInspection(ctx context.Context, id uuid.UUID) (GetImageByIDWithInspectionRow, error) {
	row := q.db.QueryRowContext(ctx, getImageByIDWithInspection, id)
	var i GetImageByIDWithInspectionRow
	err := row.Scan(
		&i.ID,
		&i.InspectionID,
		&i.StorageKey,
		&i.ThumbnailKey,
		&i.OriginalFilename,
		&i.ContentType,
		&i.SizeBytes,
		&i.Width,
		&i.Height,
		&i.AnalysisStatus,
		&i.AnalysisCompletedAt,
		&i.CreatedAt,
		&i.UserID,
	)
	return i, err
}

const listImagesByInspectionID = `-- name: ListImagesByInspectionID :many
SELECT id, inspection_id, storage_key, thumbnail_key, original_filename, content_type, size_bytes, width, height, analysis_status, analysis_completed_at, created_at FROM images
WHERE inspection_id = $1
ORDER BY created_at DESC
`

func (q *Queries) ListImagesByInspectionID(ctx context.Context, inspectionID uuid.UUID) ([]Image, error) {
	rows, err := q.db.QueryContext(ctx, listImagesByInspectionID, inspectionID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Image{}
	for rows.Next() {
		var i Image
		if err := rows.Scan(
			&i.ID,
			&i.InspectionID,
			&i.StorageKey,
			&i.ThumbnailKey,
			&i.OriginalFilename,
			&i.ContentType,
			&i.SizeBytes,
			&i.Width,
			&i.Height,
			&i.AnalysisStatus,
			&i.AnalysisCompletedAt,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const listPendingImagesByInspectionID = `-- name: ListPendingImagesByInspectionID :many
SELECT id, inspection_id, storage_key, thumbnail_key, original_filename, content_type, size_bytes, width, height, analysis_status, analysis_completed_at, created_at FROM images
WHERE inspection_id = $1
AND analysis_status = 'pending'
ORDER BY created_at ASC
`

func (q *Queries) ListPendingImagesByInspectionID(ctx context.Context, inspectionID uuid.UUID) ([]Image, error) {
	rows, err := q.db.QueryContext(ctx, listPendingImagesByInspectionID, inspectionID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []Image{}
	for rows.Next() {
		var i Image
		if err := rows.Scan(
			&i.ID,
			&i.InspectionID,
			&i.StorageKey,
			&i.ThumbnailKey,
			&i.OriginalFilename,
			&i.ContentType,
			&i.SizeBytes,
			&i.Width,
			&i.Height,
			&i.AnalysisStatus,
			&i.AnalysisCompletedAt,
			&i.CreatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const updateImageAnalysisStatus = `-- name: UpdateImageAnalysisStatus :exec
UPDATE images
SET analysis_status = $2,
    analysis_completed_at = $3
WHERE id = $1
`

type UpdateImageAnalysisStatusParams struct {
	ID                  uuid.UUID      `json:"id"`
	AnalysisStatus      sql.NullString `json:"analysis_status"`
	AnalysisCompletedAt sql.NullTime   `json:"analysis_completed_at"`
}

func (q *Queries) UpdateImageAnalysisStatus(ctx context.Context, arg UpdateImageAnalysisStatusParams) error {
	_, err := q.db.ExecContext(ctx, updateImageAnalysisStatus, arg.ID, arg.AnalysisStatus, arg.AnalysisCompletedAt)
	return err
}
